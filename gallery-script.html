<script>
/* gallery-script.js (modal fix + overlay click + ESC + animation polish) */
;(function () {
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const byText = (t) => (t||"").toLowerCase().normalize("NFKD").replace(/[^\w\s-]/g,"");
  const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  const grid = $("#pf-grid");
  const tagsWrap = $("#pf-tags");
  const searchInput = $("#pf-search");
  const clearBtn = $("#pf-clear");
  const countEl = $("#pf-count");
  const errEl = $("#pf-error");

  if (!grid) return;

  const parseTags = (el) => (el.getAttribute("data-tags")||"").split(",").map(s => s.trim().toLowerCase()).filter(Boolean);

  function readData() {
    const dataScript = document.getElementById("pf-data");
    if (!dataScript) {
      if (errEl) { errEl.hidden = false; errEl.textContent = "⚠️ Missing #pf-data JSON embed."; }
      return { items: [] };
    }
    try {
      const data = JSON.parse(dataScript.textContent || "{}");
      if (!Array.isArray(data.items)) return { baseUrl: data.baseUrl || "", items: [] };
      return { baseUrl: data.baseUrl || "", items: data.items };
    } catch (e) {
      if (errEl) { errEl.hidden = false; errEl.textContent = "⚠️ Invalid JSON in #pf-data."; }
      return { items: [] };
    }
  }

  function renderFromData(data) {
    if (!data.items.length) return;
    const base = data.baseUrl || "";
    grid.innerHTML = data.items.map(item => {
      const src = (item.src || "").startsWith("http") ? item.src : (base + (item.src || ""));
      const alt = (item.alt || "").replace(/"/g,'&quot;');
      const title = item.title || "";
      const caption = item.caption || "";
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const dataTags = tags.join(", ");
      const titleEsc = title.replace(/"/g,'&quot;');
      const captionEsc = caption.replace(/"/g,'&quot;');
      return (
        '<figure class="pf-item" data-tags="' + dataTags + '" data-title="' + titleEsc + '" data-caption="' + captionEsc + '">' +
          '<div class="thumb"><img src="' + src + '" alt="' + alt + '" loading="lazy" /></div>' +
          '<figcaption><strong>' + title + '</strong><small class="pf-card-tags"></small></figcaption>' +
        '</figure>'
      );
    }).join("");
  }

  function getParamsFromHash() {
    const h = location.hash || "";
    const qIndex = h.indexOf("?");
    return new URLSearchParams(qIndex >= 0 ? h.slice(qIndex+1) : "");
  }
  function updateHash(active, q) {
    const params = new URLSearchParams();
    if (active.length) params.set("tags", active.join(","));
    if (q) params.set("q", q);
    const base = location.href.split("#")[0];
    const hash = "gallery" + (params.toString() ? "?" + params.toString() : "");
    history.replaceState(null, "", base + "#" + hash);
  }
  function setFromParams() {
    const p = getParamsFromHash();
    const want = (p.get("tags")||"").split(",").map(s=>s.trim().toLowerCase()).filter(Boolean);
    $$(".pf-tags input[type=checkbox]", tagsWrap).forEach(cb => {
      cb.checked = want.includes(cb.value);
      const lab = cb.closest('.pf-chip');
      if (lab) lab.classList.toggle('active', cb.checked);
    });
    if (searchInput) searchInput.value = p.get("q") || "";
  }

  function wireTilt() {
    if (prefersReduced) return;
    grid.addEventListener("mousemove", (e) => {
      const card = e.target.closest(".pf-item");
      if (!card) return;
      const r = card.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      const dx = (e.clientX - cx) / r.width;
      const dy = (e.clientY - cy) / r.height;
      const max = 6;
      card.style.setProperty("--ry", (dx*max) + "deg");
      card.style.setProperty("--rx", (-dy*max) + "deg");
    });
    grid.addEventListener("mouseleave", (e) => {
      const c = e.target.closest(".pf-item");
      if (c) { c.style.setProperty("--ry","0deg"); c.style.setProperty("--rx","0deg"); }
    }, true);
  }

  /* FLIP-like zoom helper */
  function fly(fromRect, toRect, imgSrc, reverse, done) {
    if (reverse === void 0) reverse = false;
    if (!done) done = function(){};
    if (prefersReduced) { done(); return; }
    const ghost = document.createElement("img");
    ghost.src = imgSrc; ghost.alt = "";
    Object.assign(ghost.style, {
      position: "fixed",
      left: fromRect.left + "px",
      top: fromRect.top + "px",
      width: fromRect.width + "px",
      height: fromRect.height + "px",
      borderRadius: "12px",
      boxShadow: "0 10px 28px rgba(0,0,0,.25)",
      zIndex: "100000",           /* ensure above Carrd content */
      pointerEvents: "none",
      transition: "transform .32s cubic-bezier(.2,.7,.2,1), opacity .28s ease",
      transformOrigin: "center center",
      willChange: "transform, opacity"
    });
    document.body.appendChild(ghost);
    const dx = (toRect.left + toRect.width/2) - (fromRect.left + fromRect.width/2);
    const dy = (toRect.top + toRect.height/2) - (fromRect.top + fromRect.height/2);
    const sx = toRect.width / fromRect.width;
    const sy = toRect.height / fromRect.height;
    const scale = Math.min(sx, sy);
    requestAnimationFrame(function() {
      ghost.style.transform = "translate(" + dx + "px, " + dy + "px) scale(" + scale + ")";
      if (reverse) ghost.style.opacity = "0.85";
    });
    ghost.addEventListener("transitionend", function() { ghost.remove(); done(); }, { once: true });
  }
  function viewportTargetRect(maxW, maxH) {
    if (maxW === void 0) maxW = Math.min(window.innerWidth*0.92, 1200);
    if (maxH === void 0) maxH = window.innerHeight*0.88;
    const w = maxW, h = maxH;
    return { left: (window.innerWidth - w)/2, top: (window.innerHeight - h)/2, width: w, height: h };
  }

  (function init(){
    const data = readData();
    renderFromData(data);

    const items = $$(".pf-item", grid).map(function(el){
      return {
        el: el,
        title: byText(el.getAttribute("data-title")),
        caption: byText(el.getAttribute("data-caption")),
        tags: parseTags(el)
      };
    });

    items.forEach(function(i){
      const box = i.el.querySelector(".pf-card-tags");
      if (box && i.tags.length) {
        box.innerHTML = i.tags.map(function(t){ return '<span class="pf-card-tag">' + t + '</span>'; }).join("");
      }
    });

    const allTags = Array.from(new Set(items.flatMap(function(i){ return i.tags; }))).sort(function(a,b){return a.localeCompare(b);});
    allTags.forEach(function(tag){
      const id = "tg-" + tag.replace(/\s+/g,'-');
      const chip = document.createElement("label");
      chip.className = "pf-chip";
      chip.innerHTML = '<input type="checkbox" value="'+ tag +'" id="'+ id +'" aria-label="'+ tag +'"><span>'+ tag +'</span>';
      tagsWrap.appendChild(chip);
    });

    function applyFilters(pushState){
      if (pushState === void 0) pushState = false;
      const active = $$(".pf-tags input[type=checkbox]:checked", tagsWrap).map(function(cb){ return cb.value; });
      const q = byText(searchInput ? searchInput.value : "");
      var visible = 0;
      items.forEach(function(i){
        const matchTags = active.every(function(tag){ return i.tags.includes(tag); });
        const matchText = !q || i.title.includes(q) || i.caption.includes(q) || i.tags.join(" ").includes(q);
        const show = matchTags && matchText;
        i.el.classList.toggle("pf-hide", !show);
        if (show) visible++;
      });
      if (countEl) countEl.textContent = visible + " result" + (visible===1?"":"s");
      if (pushState) updateHash(active, (searchInput ? searchInput.value : ""));
    }

    if (tagsWrap) {
      tagsWrap.addEventListener("change", function(e){
        const cb = e.target.closest('input[type=checkbox]');
        if (cb) {
          const lab = cb.closest('.pf-chip');
          if (lab) lab.classList.toggle('active', cb.checked);
        }
        applyFilters(true);
      });
    }
    if (searchInput) searchInput.addEventListener("input", function(){ applyFilters(true); });
    if (clearBtn) clearBtn.addEventListener("click", function(){
      $$(".pf-tags input[type=checkbox]", tagsWrap).forEach(function(cb){
        cb.checked = false;
        const lab = cb.closest('.pf-chip');
        if (lab) lab.classList.remove('active');
      });
      if (searchInput) searchInput.value = "";
      applyFilters(true);
    });

    setFromParams(); applyFilters(false);
    window.addEventListener("hashchange", function(){
      if ((location.hash||"").startsWith("#gallery")) { setFromParams(); applyFilters(false); }
    });

    wireTilt();

    /* ===== Modal behavior (open/close robust) ===== */
    const modal = $("#pf-modal");
    const mImg = $("#pf-modal-img");
    const mTitle = $("#pf-modal-title");
    const mCap = $("#pf-modal-cap");
    const mClose = $("#pf-modal-close");
    let lastThumb = null, lastRect = null;

    function openModal(fromItem) {
      if (!modal) return;
      const img = fromItem.querySelector("img");
      mImg.src = img.src; mImg.alt = img.alt || "";
      mTitle.textContent = fromItem.getAttribute("data-title") || "";
      mCap.textContent = fromItem.getAttribute("data-caption") || "";

      lastThumb = img; lastRect = img.getBoundingClientRect();
      const target = viewportTargetRect();

      // Animate up, then show modal overlay
      fly(lastRect, target, img.src, false, function(){
        modal.classList.add("is-open");
        document.body.classList.add("pf-lock");
        modal.setAttribute("aria-hidden","false");
      });
    }

    function closeModal() {
      if (!modal) return;
      const wasOpen = modal.classList.contains("is-open");
      modal.classList.remove("is-open");
      document.body.classList.remove("pf-lock");
      modal.setAttribute("aria-hidden","true");
      // Animate back down after overlay is hidden
      if (wasOpen && lastThumb && lastRect && !prefersReduced) {
        const target = lastThumb.getBoundingClientRect();
        fly(viewportTargetRect(), target, mImg.src, true, function(){});
      }
    }

    // Open on card click
    grid.addEventListener("click", function(e){
      const card = e.target.closest(".pf-item");
      if (card) openModal(card);
    });

    // X button
    if (mClose) mClose.addEventListener("click", closeModal);

    // Click outside inner to close (more robust than target===modal)
    if (modal) modal.addEventListener("click", function(e){
      if (!e.target.closest(".inner")) closeModal();
    });

    // ESC on document (some templates eat window events)
    document.addEventListener("keydown", function(e){
      if (e.key === "Escape") closeModal();
    });
  })();
})();
</script>
